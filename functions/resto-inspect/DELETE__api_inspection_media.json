{
  "method": "DELETE",
  "url": "/api/inspection/media",
  "functionName": "DELETE",
  "functionFile": "/Users/kurttimajo/dev/restoremasters/resto-inspect/src/app/api/inspection/media/route.ts",
  "functionCode": "export async function DELETE(request: NextRequest) {\n  try {\n    const { inspectionId, mediaUrl, mediaType, s3Key } = await request.json()\n    if (!inspectionId || (!mediaUrl && !s3Key) || !mediaType) {\n      return NextResponse.json({ error: 'inspectionId, (mediaUrl or s3Key), mediaType are required' }, { status: 400 })\n    }\n\n    const inspection = await prisma.inspection.findUnique({ where: { id: inspectionId }, select: { photoUrls: true, videoUrls: true } })\n    if (!inspection) return NextResponse.json({ error: 'Inspection not found' }, { status: 404 })\n\n    const list = mediaType === 'photo' ? (inspection.photoUrls || []) : (inspection.videoUrls || [])\n\n    const deriveKeyFromUrl = (inputUrl: string): string | null => {\n      try {\n        const u = new URL(inputUrl)\n        let pathname = u.pathname || ''\n        if (pathname.startsWith('/')) pathname = pathname.slice(1)\n        if (pathname.startsWith('test/')) pathname = pathname.slice(5)\n        return pathname || null\n      } catch {\n        return null\n      }\n    }\n\n    const targetKey = s3Key || (mediaUrl ? deriveKeyFromUrl(mediaUrl) : null)\n\n    // Find the matching entry (supports JSON string, raw URL, or key match)\n    let removedKey: string | null = null\n    const filtered = list.filter((entry) => {\n      try {\n        const parsed = JSON.parse(entry)\n        const entryKey: string | null = parsed.key || (parsed.url ? deriveKeyFromUrl(parsed.url) : null)\n        const matchByKey = targetKey && entryKey && entryKey === targetKey\n        const matchByUrl = mediaUrl && parsed.url === mediaUrl\n        if (matchByKey || matchByUrl) {\n          removedKey = entryKey\n          return false\n        }\n        return true\n      } catch {\n        if (!entry) return true\n        if (mediaUrl && entry === mediaUrl) return false\n        const entryKey = deriveKeyFromUrl(entry)\n        if (targetKey && entryKey && entryKey === targetKey) return false\n        return true\n      }\n    })\n\n    // Delete from S3 if we have a key\n    if (removedKey || targetKey) {\n      const s3 = new S3Service()\n      try {\n        await s3.deleteFile((removedKey || targetKey) as string)\n      } catch (e) {\n        console.warn('S3 delete failed (continuing DB update):', e)\n      }\n    }\n\n    const data: any = {}\n    if (mediaType === 'photo') data.photoUrls = filtered\n    else data.videoUrls = filtered\n\n    const updated = await prisma.inspection.update({ where: { id: inspectionId }, data })\n    return NextResponse.json({ success: true, inspection: updated })\n  } catch (error) {\n    console.error('Delete media error:', error)\n    return NextResponse.json({ error: 'Failed to delete media' }, { status: 500 })\n  }\n}",
  "functionResolutionConfidence": "high"
}